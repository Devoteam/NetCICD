lab:
  description: LAB specifically created for NetCICD Box testing
  notes: ''
  timestamp: 1611948996.4444916
  title: NetCICD Box
  version: 0.0.4
nodes:
  - id: n0
    label: NetCICD_agent
    node_definition: alpine
    x: -500
    y: -100
    configuration: |-
      # this is a shell script which will be sourced at boot
      # if you change the hostname then you need to add a
      # /etc/hosts entry as well
      hostname NetCICD_agent
      # like this:
      echo "127.0.0.1   NetCICD_agent" >>/etc/hosts
      echo "http://dl-cdn.alpinelinux.org/alpine/v3.12/community" >> /etc/apk/repositories
      apk update
      apk add --update openjdk8 git openssh openssh-keygen openssl libxml2-dev libxslt-dev sshpass
      sudo chmod o+w /etc/hosts
      if grep -q "gitea" /etc/hosts; then
          echo " Gitea exists in /etc/hosts"
      else
          echo " Add Gitea to /etc/hosts"
          sudo echo "172.16.11.3   gitea" >> /etc/hosts
      fi

      if grep -q "jenkins" /etc/hosts; then
          echo " Jenkins exists in /etc/hosts"
      else
          echo " Add Jenkins to /etc/hosts"
          sudo echo "172.16.11.8   jenkins" >> /etc/hosts
      fi

      if grep -q "nexus" /etc/hosts; then
          echo " Nexus exists in /etc/hosts"
      else
          echo " Add Nexus to /etc/hosts"
          sudo echo "172.16.11.9   nexus" >> /etc/hosts
      fi

      pip3 install --upgrade pip
      
      export GROOVY_VERSION=2.5.8
      export GROOVY_HOME="/usr/share/groovy"
      
      apk --update add --virtual .build-deps gcc libffi-dev openssl-dev build-base \
       && pip3 install --upgrade cffi ncclient virlutils \
       && pip3 install ansible \
       && wget -q -O /tmp/groovy.zip "https://dl.bintray.com/groovy/maven/apache-groovy-binary-${GROOVY_VERSION}.zip" \
       && unzip -o -d "/tmp" "/tmp/groovy.zip" \
       && mv "/tmp/groovy-${GROOVY_VERSION}" "/usr/share/groovy" \
       && apk del .build-deps \
       && rm -rf /var/cache/apk/*

      echo -e """\
      \n\
      Host *\n\
          PasswordAuthentication yes\n\
          StrictHostKeyChecking no\n\
          UserKnownHostsFile=/dev/null\n\
      """ >> /etc/ssh/ssh_config

      echo "export PATH=$PATH:/usr/share/groovy/bin" >> /etc/profile
      echo "export JAVA_HOME=/usr" >> /etc/profile

      /usr/share/groovy/bin/grape install org.codehaus.groovy.modules.http-builder http-builder 0.7.2
      adduser -D jenkins && (echo "jenkins:jenkins" | chpasswd) && (echo "root:root" | chpasswd)
      #COPY rawPopulator.groovy /home/jenkins/
      #COPY agent.jar /home/jenkins/
      #RUN echo "[defaults]" > /home/jenkins/.ansible.cfg
      #RUN echo "host_key_checking = False" >> /home/jenkins/.ansible.cfg
      #RUN chown jenkins:jenkins /home/jenkins/.ansible.cfg
      #RUN chown -R jenkins:jenkins /home/jenkins

      #COPY agent.jar /root/
      #RUN echo "[defaults]" > /root/.ansible.cfg
      #RUN echo "host_key_checking = False" >> /root/.ansible.cfg
      #RUN ln -s /usr/bin/python3 /usr/bin/python
      ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
      echo "export VIRL=0" >> /etc/profile
      echo 'export GIT_URL=http://172.16.1.254/netarch/NetCICD.git' &gt;&gt; /etc/profile&#xD;
      java -jar /root/agent.jar -jnlpUrl jenkins_urlcomputer/jenkins_agent/slave-agent.jnlp -secret jenkins_secret -workDir "/root/jenkins_slave"
      chown jenkins:jenkins /home/jenkins/.profile
      chmod 755 /home/jenkins/.profile
      ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
      git config --global user.name "jenkins_agent"
      git config --global user.email "jenkins_agent@infraautomators.example.com"
      git clone $GIT_URL
      cd NetCICD
      git status
      echo "===== Starting Stage 0 playbook (box) ====="
      cd roles/box/vars
      ln -s stage0.yml main.yml
      cd ~/NetCICD
      ansible-playbook -i vars/stage0 stage0.yml -e stage=0
      echo "========= Ready for modification =========="
      echo "You can now:"
      echo " - create a branch with git branch &lt;mybranch&gt;"
      echo " - view which files you changed with git status"
      echo " - stage your changed files with git add"
      echo ' - commit with git commit -m "&lt;commit message&gt;"'
      echo ' - push the changes to the git server with git push --set-upstream origin &lt;mybranch&gt;'
      echo ""
      echo "============= Have Fun! ==============="
    image_definition: alpine-3-12-base
    tags: []
    interfaces:
      - id: i0
        slot: 0
        label: eth0
        type: physical
      - id: i1
        slot: 1
        label: eth1
        type: physical
      - id: i2
        slot: 2
        label: eth2
        type: physical
      - id: i3
        slot: 3
        label: eth3
        type: physical
  - id: n1
    label: ext-conn-0
    node_definition: external_connector
    x: -500
    y: -200
    configuration: virbr0
    tags: []
    interfaces:
      - id: i0
        slot: 0
        label: port
        type: physical
  - id: n2
    label: iosv-0
    node_definition: iosv
    x: -650
    y: 0
    configuration: ''
    image_definition: iosv-159-3
    tags: []
    interfaces:
      - id: i0
        label: Loopback0
        type: loopback
      - id: i1
        slot: 0
        label: GigabitEthernet0/0
        type: physical
      - id: i2
        slot: 1
        label: GigabitEthernet0/1
        type: physical
      - id: i3
        slot: 2
        label: GigabitEthernet0/2
        type: physical
      - id: i4
        slot: 3
        label: GigabitEthernet0/3
        type: physical
  - id: n3
    label: xrv-0
    node_definition: iosxrv
    x: -500
    y: 100
    configuration: ''
    image_definition: iosxrv-6-3-1
    tags: []
    interfaces:
      - id: i0
        label: Loopback0
        type: loopback
      - id: i1
        slot: 0
        label: MgmtEth0/0/CPU0/0
        type: physical
      - id: i2
        slot: 1
        label: GigabitEthernet0/0/0/0
        type: physical
      - id: i3
        slot: 2
        label: GigabitEthernet0/0/0/1
        type: physical
      - id: i4
        slot: 3
        label: GigabitEthernet0/0/0/2
        type: physical
  - id: n4
    label: xr9kv-0
    node_definition: iosxrv9000
    x: -350
    y: 0
    configuration: |-
      hostname changeme
      username cisco
      group root-lr
      group cisco-support
      password cisco
      !
      username admin
      group root-lr
      group cisco-support
      password admin
      !
      username lab
      group root-lr
      group cisco-support
      password lab
      !
      end
    image_definition: iosxrv9000-7-2-1
    tags: []
    interfaces:
      - id: i0
        label: Loopback0
        type: loopback
      - id: i1
        slot: 0
        label: MgmtEth0/RP0/CPU0/0
        type: physical
      - id: i2
        slot: 1
        label: donotuse1
        type: physical
      - id: i3
        slot: 2
        label: donotuse2
        type: physical
      - id: i4
        slot: 3
        label: GigabitEthernet0/0/0/0
        type: physical
  - id: n5
    label: unmanaged-switch-0
    node_definition: unmanaged_switch
    x: -500
    y: 0
    configuration: ''
    tags: []
    interfaces:
      - id: i0
        slot: 0
        label: port0
        type: physical
      - id: i1
        slot: 1
        label: port1
        type: physical
      - id: i2
        slot: 2
        label: port2
        type: physical
      - id: i3
        slot: 3
        label: port3
        type: physical
      - id: i4
        slot: 4
        label: port4
        type: physical
      - id: i5
        slot: 5
        label: port5
        type: physical
      - id: i6
        slot: 6
        label: port6
        type: physical
      - id: i7
        slot: 7
        label: port7
        type: physical
links:
  - id: l0
    i1: i0
    n1: n1
    i2: i0
    n2: n0
  - id: l1
    i1: i1
    n1: n2
    i2: i0
    n2: n5
  - id: l2
    i1: i1
    n1: n4
    i2: i1
    n2: n5
  - id: l3
    i1: i1
    n1: n3
    i2: i2
    n2: n5
  - id: l4
    i1: i3
    n1: n5
    i2: i1
    n2: n0
