lab:
  description: LAB specifically created for NetCICD Box testing
  notes: ''
  timestamp: 1619408255.058225
  title: NetCICD Stage Box
  version: 0.0.4
nodes:
  - id: n0
    label: NetCICD_agent
    node_definition: desktop
    x: -500
    y: -100
    configuration: |-
      # this is a shell script which will be sourced at boot
      # This Source Code Form is subject to the terms of the Mozilla Public
      # License, v. 2.0. If a copy of the MPL was not distributed with this
      # file, You can obtain one at http://mozilla.org/MPL/2.0/.
      hostname NetCICD_agent

      # Making sure Toolbox hosts are reachable by name
      echo "127.0.0.1   NetCICD_agent" >>/etc/hosts

      if grep -q "gitea" /etc/hosts; then
        echo " Gitea exists in /etc/hosts" >>/home/cisco/install-log.txt
      else
        echo " Add Gitea to /etc/hosts" >>/home/cisco/install-log.txt
        sudo echo "172.16.11.3   gitea" >> /etc/hosts
      fi

      if grep -q "jenkins" /etc/hosts; then
        echo " Jenkins exists in /etc/hosts" >>/home/cisco/install-log.txt
      else
        echo " Add Jenkins to /etc/hosts" >>/home/cisco/install-log.txt
        sudo echo "172.16.11.8   jenkins" >> /etc/hosts
      fi

      if grep -q "nexus" /etc/hosts; then
        echo " Nexus exists in /etc/hosts" >>/home/cisco/install-log.txt
      else
        echo " Add Nexus to /etc/hosts" >>/home/cisco/install-log.txt
        sudo echo "172.16.11.9   nexus" >> /etc/hosts
      fi

      # Setting Alpine repo to proxy host to enable curated packages
      if $(wget http://nexus:8081); then
        echo "NetCICD Toolbox installed. Setting APK repositories to Nexus." >>/home/cisco/install-log.txt
        echo "http://nexus:8081/repository/apk-main-proxy/" > /etc/apk/repositories
        echo "http://nexus:8081/repository/apk-community-proxy/" >> /etc/apk/repositories
        echo "http://nexus:8081/repository/apk-testing-proxy/" >> /etc/apk/repositories
      else
        echo "NetCICD Toolbox not installed. Setting APK repository to Nexus." >>/home/cisco/install-log.txt
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.12/community" >> /etc/apk/repositories
        echo "http://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories
      fi

      # Installing required packages
      apk update
      apk add --update --no-cache openjdk8 git openssh openssh-keygen openssl libxml2-dev libxslt-dev sshpass python3 py3-pip rsyslog maven ansible curl py3-lxml py3-six py3-paramiko py3-ncclient docker
      addgroup cisco docker
      rc-update add docker boot

      # Setting Docker repo to proxy host to enable curated packages
      wget https://raw.githubusercontent.com/Devoteam/NetCICD/master/cml2/daemon.json
      sudo mkdir /etc/docker
      sudo mv daemon.json /etc/docker/daemon.json
      sudo chmod 644 /etc/docker/daemon.json
      sudo chown root:root /etc/docker/daemon.json

      sudo service docker restart
      sudo chmod 666 /var/run/docker.sock

      pip install ncclient

      # Preparing interface to lab
      echo "auto eth1" >> /etc/network/interfaces
      echo "iface eth1 inet static" >> /etc/network/interfaces
      echo "        address 10.255.1.1" >> /etc/network/interfaces
      echo "        netmask 255.255.255.0" >> /etc/network/interfaces
      /etc/init.d/networking restart


      # Preparing ssh
      echo -e """\
      \n\
      Host *\n\
          PasswordAuthentication yes\n\
          StrictHostKeyChecking no\n\
          UserKnownHostsFile=/dev/null\n\
          HostkeyAlgorithms ssh-dss,ssh-rsa\n\
          KexAlgorithms +diffie-hellman-group14-sha1\n\
      """ >> /etc/ssh/ssh_config

      # Prepare Ansible
      echo "[defaults]" > /home/cisco/.ansible.cfg
      echo "host_key_checking = False" >> /home/cisco/.ansible.cfg
      chown cisco:cisco /home/cisco/.ansible.cfg

      # set vars
      if wget ${GIT_URL}; then
        echo 'export GIT_URL=http://gitea:3000/infraautomator/' >> /etc/profile
      else
        echo 'export GIT_URL=https://github.com/Devoteam/' >> /etc/profile
      fi

      echo "export JAVA_HOME=/usr" >> /etc/profile

      # Configuring rsyslog host for testing log configuration on devices
      cd /etc
      rm rsyslog.conf
      if wget ${GIT_URL}/NetCICD/raw/branch/master/Docker/Syslog/rsyslog.conf; then
        echo "NetCICD Toolbox installed. Retrieved rsyslog.conf from NetCICD-Developer-Toolbox." >>/home/cisco/install-log.txt
      else
        echo "NetCICD Toolbox not installed. Retrieving rsyslog.conf from github." >>/home/cisco/install-log.txt
        wget https://raw.githubusercontent.com/Devoteam/NetCICD/master/Docker/Syslog/rsyslog.conf
      fi
      rc-service rsyslog restart

      # Preparing Jenkins connection
      cd /home/cisco
      if wget http://jenkins:8080/jnlpJars/agent.jar; then
        echo "NetCICD Toolbox installed. Retrieved agent.jar from NetCICD-Developer-Toolbox."  >>/home/cisco/install-log.txt
        agent=1
        chown cisco:cisco agent.jar
        echo jenkins_secret > secret-file
        chown cisco:cisco secret-file
        sudo -H -u cisco java -jar agent.jar -jnlpUrl http://jenkins:8080/computer/jenkins_agent/jenkins-agent.jnlp -secret @secret-file -workDir "/home/cisco" &
      else
        echo "NetCICD Toolbox not installed. Skipping jenkins agent start." >>/home/cisco/install-log.txt
      fi

      # Installing .profile script to prepare for Ansible playbook run
      if wget ${GIT_URL}/NetCICD/raw/branch/master/cml2/stage-box.profile; then
        echo "NetCICD Toolbox installed. Retrieved stage-box.profile from NetCICD-Developer-Toolbox." >>/home/cisco/install-log.txt
      else
        echo "NetCICD Toolbox not installed. Retrieving stage-box.profile from github." >>/home/cisco/install-log.txt
        wget https://raw.githubusercontent.com/Devoteam/NetCICD/master/cml2/stage-box.profile
      fi
      mkdir /home/cisco/.ssh
      chown cisco:cisco /home/cisco/.ssh
      chown cisco:cisco /home/cisco/.ssh/*
      ssh-keygen -t rsa -N "" -f /home/cisco/.ssh/id_rsa -C netcicd-pipeline@infraautomator.example.com
      # mv stage-box.profile .profile
    image_definition: desktop-3-12-xfce
    tags: []
    interfaces:
      - id: i0
        slot: 0
        label: eth0
        type: physical
      - id: i1
        slot: 1
        label: eth1
        type: physical
      - id: i2
        slot: 2
        label: eth2
        type: physical
      - id: i3
        slot: 3
        label: eth3
        type: physical
  - id: n1
    label: ext-conn-0
    node_definition: external_connector
    x: -500
    y: -200
    configuration: virbr0
    tags: []
    interfaces:
      - id: i0
        slot: 0
        label: port
        type: physical
  - id: n2
    label: CE1,144, ios
    node_definition: iosv
    x: -650
    y: 0
    configuration: |-
      aaa new-model
      !
      aaa session-id common
      aaa authorization exec default local
      !
      no ip icmp rate-limit unreachable
      !
      ip domain name netcicd
      !
      hostname cust1
      username netcicd-pipeline privilege 15 secret C!sco123
      enable secret C!sco123
      !
      ip tcp synwait-time 5
      ip ssh version 2
      crypto key gen rsa mod 2048
      !
      interface GigabitEthernet0/0
       ip address 10.255.1.144 255.255.255.0
       no shutdown
       duplex auto
       speed auto
       media-type rj45
      !
      interface GigabitEthernet0/1
       no ip address
       shutdown
       duplex auto
       speed auto
       media-type rj45
      !
      interface GigabitEthernet0/2
       no ip address
       shutdown
       duplex auto
       speed auto
       media-type rj45
      !
      interface GigabitEthernet0/3
       no ip address
       shutdown
       duplex auto
       speed auto
       media-type rj45
      !
      line vty 0 4
       transport input telnet ssh
      !
      end
    image_definition: iosv-159-3
    tags:
      - CE1
    interfaces:
      - id: i0
        label: Loopback0
        type: loopback
      - id: i1
        slot: 0
        label: GigabitEthernet0/0
        type: physical
      - id: i2
        slot: 1
        label: GigabitEthernet0/1
        type: physical
      - id: i3
        slot: 2
        label: GigabitEthernet0/2
        type: physical
      - id: i4
        slot: 3
        label: GigabitEthernet0/3
        type: physical
  - id: n3
    label: PE1, 110, XRv
    node_definition: iosxrv
    x: -500
    y: 100
    configuration: |2-

      Fri Apr  9 06:53:26.092 UTC
      Building configuration...
      !! IOS XR Configuration 6.3.1
      !! Last configuration change at Fri Apr  9 06:53:23 2021 by cisco
      !
      hostname provedge2
      logging console disable
      service timestamps log datetime msec
      service timestamps debug datetime msec
      telnet vrf default ipv4 server max-servers 10
      telnet vrf Mgmt-intf ipv4 server max-servers 10
      domain name netcicd
      domain lookup disable
      username netcicd-pipeline
        group root-lr
        secret 0 C!sco123
      !
      line template vty
       timestamp
       exec-timeout 720 0
      !
      line console
       exec-timeout 0 0
       absolute-timeout 0
       session-timeout 0
      !
      line default
       exec-timeout 0 0
       absolute-timeout 0
       session-timeout 0
      !
      vty-pool default 0 50
      control-plane
       management-plane
        inband
         interface all
          allow all
         !
        !
       !
      !
      interface Loopback0
       description to
       shutdown
      !
      interface MgmtEth0/0/CPU0/0
       description *** management ***
       ipv4 address 10.255.1.128 255.255.255.0
       no shutdown
      !
      interface GigabitEthernet0/0/0/0
       description to
       shutdown
      !
      interface GigabitEthernet0/0/0/1
       description to
       shutdown
      !
      interface GigabitEthernet0/0/0/2
       description to
       shutdown
      !
      netconf agent tty
      !
      netconf-yang agent
       ssh
      !
      ssh server v2
      ssh server netconf vrf default
      end
    image_definition: iosxrv-6-3-1
    tags: []
    interfaces:
      - id: i0
        label: Loopback0
        type: loopback
      - id: i1
        slot: 0
        label: MgmtEth0/0/CPU0/0
        type: physical
      - id: i2
        slot: 1
        label: GigabitEthernet0/0/0/0
        type: physical
      - id: i3
        slot: 2
        label: GigabitEthernet0/0/0/1
        type: physical
      - id: i4
        slot: 3
        label: GigabitEthernet0/0/0/2
        type: physical
  - id: n5
    label: unmanaged-switch-0
    node_definition: unmanaged_switch
    x: -500
    y: 0
    configuration: ''
    tags: []
    interfaces:
      - id: i0
        slot: 0
        label: port0
        type: physical
      - id: i1
        slot: 1
        label: port1
        type: physical
      - id: i2
        slot: 2
        label: port2
        type: physical
      - id: i3
        slot: 3
        label: port3
        type: physical
      - id: i4
        slot: 4
        label: port4
        type: physical
      - id: i5
        slot: 5
        label: port5
        type: physical
      - id: i6
        slot: 6
        label: port6
        type: physical
      - id: i7
        slot: 7
        label: port7
        type: physical
  - id: n7
    label: PE3, 130, nxos
    node_definition: nxosv
    x: -350
    y: 0
    configuration: |-
      !
      license grace-period
      !
      hostname PE3
      vdc nxos-0 id 1
        allocate interface Ethernet2/1-48
        allocate interface Ethernet3/1-48
        limit-resource vlan minimum 16 maximum 4094
        limit-resource vrf minimum 2 maximum 4096
        limit-resource port-channel minimum 0 maximum 768
        limit-resource u4route-mem minimum 96 maximum 96
        limit-resource u6route-mem minimum 24 maximum 24
        limit-resource m4route-mem minimum 58 maximum 58
        limit-resource m6route-mem minimum 8 maximum 8

      feature telnet
      feature privilege
      feature scp
      feature ssh

      username adminbackup password 5 ! role network-operator
      username admin password C!sco123 role network-admin
      username netcicd-pipeline password C!sco123 role network-operator
      username netcicd-pipeline role network-admin

      no password strength-check
      ip domain-lookup
      copp profile strict

      rmon event 1 log trap public description FATAL(1) owner PMON@FATAL
      rmon event 2 log trap public description CRITICAL(2) owner PMON@CRITICAL
      rmon event 3 log trap public description ERROR(3) owner PMON@ERROR
      rmon event 4 log trap public description WARNING(4) owner PMON@WARNING
      rmon event 5 log trap public description INFORMATION(5) owner PMON@INFO

      vlan 1

      hardware forwarding unicast trace

      vrf context management
      hardware forwarding unicast trace

      interface Loopback0
          description PE3-Loopback
          ip address 192.168.0.130/32
          duplex auto
          no shut

      interface mgmt0
          description OOB Management
          ip address 10.255.1.130 255.255.255.0
          duplex auto
          no shut

      interface Ethernet2/1
          description to
          no ip address
          duplex full
          shutdown

      interface Ethernet2/2
          description to
          no ip address
          duplex full
          shutdown

      interface Ethernet2/3
          description to
          no ip address
          duplex full
          shutdown

      !
      ssh key rsa 2048
      !
      xml server max-session 8
      xml server timeout 1200

      line console
      line vty
    image_definition: nxosv-7-3-0
    tags: []
    interfaces:
      - id: i0
        label: Loopback0
        type: loopback
      - id: i1
        slot: 0
        label: mgmt0
        type: physical
      - id: i2
        slot: 1
        label: Ethernet2/1
        type: physical
      - id: i3
        slot: 2
        label: Ethernet2/2
        type: physical
      - id: i4
        slot: 3
        label: Ethernet2/3
        type: physical
  - id: n9
    label: RR1, 121, xe
    node_definition: csr1000v
    x: -650
    y: 100
    configuration: |-
      hostname reflector
      !
      username netcicd-pipeline privilege 15 secret C!sco123
      !
      interface GigabitEthernet1
       ip address 10.255.1.121 255.255.255.0
       negotiation auto
       no shutdown
      enable secret C!sco123
      aaa new-model
      aaa session-id common
      aaa authorization exec default local
      ip domain name netcicd
      ip ssh version 2
      crypto key gen rsa mod 2048
      !
    image_definition: csr1000v-170301a
    tags: []
    interfaces:
      - id: i0
        label: Loopback0
        type: loopback
      - id: i1
        slot: 0
        label: GigabitEthernet1
        type: physical
      - id: i2
        slot: 1
        label: GigabitEthernet2
        type: physical
      - id: i3
        slot: 2
        label: GigabitEthernet3
        type: physical
      - id: i4
        slot: 3
        label: GigabitEthernet4
        type: physical
links:
  - id: l0
    i1: i0
    n1: n1
    i2: i0
    n2: n0
  - id: l1
    i1: i1
    n1: n2
    i2: i0
    n2: n5
  - id: l3
    i1: i1
    n1: n3
    i2: i2
    n2: n5
  - id: l4
    i1: i3
    n1: n5
    i2: i1
    n2: n0
  - id: l2
    i1: i1
    n1: n7
    i2: i1
    n2: n5
  - id: l7
    i1: i1
    n1: n9
    i2: i5
    n2: n5