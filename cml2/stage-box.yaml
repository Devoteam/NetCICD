# this is a shell script which will be sourced at boot
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
hostname NetCICD_agent

# Making sure Toolbox hosts are reachable by name 
echo "127.0.0.1   NetCICD_agent" >>/etc/hosts

if grep -q "gitea" /etc/hosts; then
  echo " Gitea exists in /etc/hosts" >>/home/cisco/install-log.txt
else
  echo " Add Gitea to /etc/hosts" >>/home/cisco/install-log.txt
  sudo echo "172.16.11.3   gitea" >> /etc/hosts
fi

if grep -q "jenkins" /etc/hosts; then
  echo " Jenkins exists in /etc/hosts" >>/home/cisco/install-log.txt
else
  echo " Add Jenkins to /etc/hosts" >>/home/cisco/install-log.txt
  sudo echo "172.16.11.8   jenkins" >> /etc/hosts
fi

if grep -q "nexus" /etc/hosts; then
  echo " Nexus exists in /etc/hosts" >>/home/cisco/install-log.txt
else
  echo " Add Nexus to /etc/hosts" >>/home/cisco/install-log.txt
  sudo echo "172.16.11.9   nexus" >> /etc/hosts
fi

# Setting Alpine repo to proxy host to enable curated packages
if $(curl --output /dev/null --silent --head --fail http://nexus:8081); then
  echo "NetCICD Toolbox installed. Setting APK repositories to Nexus." >>/home/cisco/install-log.txt
  echo "http://nexus:8081/repository/apk-main-proxy/" > /etc/apk/repositories
  echo "http://nexus:8081/repository/apk-community-proxy/" >> /etc/apk/repositories
else
  echo "NetCICD Toolbox not installed. Setting APK repository to Nexus." >>/home/cisco/install-log.txt
  echo "http://dl-cdn.alpinelinux.org/alpine/v3.12/community" >> /etc/apk/repositories
fi

# Installing required packages
apk update
apk add --update --no-cache openjdk8 git openssh openssh-keygen openssl libxml2-dev libxslt-dev sshpass python3 py3-pip rsyslog maven ansible

cd /etc
echo 'export GIT_URL=http://gitea:3000/infraautomator/' >> /etc/profile

# Configuring rsyslog host for testing log configuration on devices
rm rsyslog.conf
if wget ${GIT_URL}/NetCICD/raw/branch/master/Docker/Syslog/rsyslog.conf; then
  echo "NetCICD Toolbox installed. Retrieved rsyslog.conf from NetCICD-Developer-Toolbox." >>/home/cisco/install-log.txt
else
  echo "NetCICD Toolbox not installed. Retrieving rsyslog.conf from github." >>/home/cisco/install-log.txt
  wget https://raw.githubusercontent.com/Devoteam/NetCICD/master/Docker/Syslog/rsyslog.conf
fi
rc-service rsyslog restart

# Preparing Jenkins connection
cd /home/cisco
if wget http://jenkins:8080/jnlpJars/agent.jar; then
  echo "NetCICD Toolbox installed. Retrieved agent.jar from NetCICD-Developer-Toolbox."  >>/home/cisco/install-log.txt
  agent=1
  chown cisco:cisco agent.jar
  echo jenkins_secret > secret-file
  chown cisco:cisco secret-file
  java -jar agent.jar -jnlpUrl http://jenkins:8080/computer/jenkins_agent/jenkins-agent.jnlp -secret @secret-file -workDir "/home/cisco" &
else
  echo "NetCICD Toolbox not installed. Skipping jenkins agent start." >>/home/cisco/install-log.txt
fi

# INstalling .profile script to prepare for Ansible playbook run
if wget ${GIT_URL}/NetCICD/raw/branch/master/cml2/stage-box.profile; then
  echo "NetCICD Toolbox installed. Retrieved stage-box.profile from NetCICD-Developer-Toolbox." >>/home/cisco/install-log.txt
else
  echo "NetCICD Toolbox not installed. Retrieving stage-box.profile from github." >>/home/cisco/install-log.txt
  wget https://raw.githubusercontent.com/Devoteam/NetCICD/master/cml2/stage-box.profile
fi

mv stage-box.profile .profile
chown cisco:cisco .profile